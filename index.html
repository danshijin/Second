<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.min.js"></script>
		<script src="js/echarts.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">
			mui.init();
		</script>
	</head>

	<body>
		<!-- 为 ECharts 准备一个具备大小（宽高）的 DOM -->
		<div id="main" style="width: 100%;height:400px;"></div>
		<a href="watchPriceTable.html">手表历史价格</a>
	</body>
	<script>
		mui.plusReady(function(){
			var today = new Date();
			var key = getFormatDate(today);
			var value = localStorage.getItem(key);
			if(value != null && value != "null") {
				mui.toast("今日手表数据已存在" + value);
				return;
			}
			var url = "https://www.amazon.com/s/ref=nb_sb_noss?url=search-alias%3Daps&field-keywords=sne329";
			mui.toast("抓取商品页面文本..");
			mui.get(url, {}, function(data){
				mui.toast("解析数据..");
				getWatchesPrice(data);
			},"html");
		});
		
		function getWatchesPrice(content) {
			
			var priceStartStr = "a-size-small a-color-price a-text-bold\">$";
			var priceList = getListByTag(content, priceStartStr, "<");
			var itemNameStartStr = "a-size-base a-color-base sx-title\">";
			var itemNameList = getListByTag(content, itemNameStartStr, "<");
			var watch = {};
			for(var i = 0; i < priceList.length; i++) {
				if(itemNameList[i].indexOf("SNE329") > -1) {
					watch.SNE329 = priceList[i];
				} else if(itemNameList[i].indexOf("SNE331") > -1) {
					watch.SNE331 = priceList[i];
				}
			} 
			var today = new Date();
			var key = getFormatDate(today);
			var value = JSON.stringify(watch);
			localStorage.setItem(key, value);
			mui.alert("今日手表数据保存成功" + value);
		}
		
		function getFormatDate(calendar){
			var month = "" + (calendar.getMonth() + 1);
			if(month.length == 1) {
				month = "0" + month;
			}
			var date = "" + calendar.getDate();
			if(date.length == 1) {
				date = "0" + date;
			}
			return ""+ calendar.getFullYear() + month + date;
		}
		
		function getListByTag(content, startTag, endTag) {
			var resultList = [];
			var startIndex = 0;
			var maxItemCount = 5;
			var index = 0;
			while(true) {
				startIndex = content.indexOf(startTag, startIndex);
				if(startIndex == -1) {
					break;
				}
				startIndex += startTag.length;
				var endIndex = content.indexOf(endTag, startIndex);
				var price = content.substring(startIndex, endIndex);
				resultList.push(price);
				if(index >= maxItemCount) {
					break;
				}
				index++;
			}
			return resultList;
		}
	
		// 基于准备好的dom，初始化echarts实例
		var myChart = echarts.init(document.getElementById('main'));

		// 指定图表的配置项和数据
		var option = {
			title: {
				text: 'ECharts 入门示例'
			},
			tooltip: {},
			legend: {
				data: ['销量']
			},
			xAxis: {
				data: ["衬衫", "羊毛衫", "雪纺衫", "裤子", "高跟鞋", "袜子"]
			},
			yAxis: {},
			series: [{
				name: '销量',
				type: 'bar',
				data: [5, 20, 36, 10, 10, 20]
			}]
		};

		// 使用刚指定的配置项和数据显示图表。
		myChart.setOption({
			series: [{
				name: '访问来源',
				type: 'pie',
				radius: '55%',
				data: [{
					value: 400,
					name: '搜索引擎'
				}, {
					value: 335,
					name: '直接访问'
				}, {
					value: 310,
					name: '邮件营销'
				}, {
					value: 274,
					name: '联盟广告'
				}, {
					value: 235,
					name: '视频广告'
				}]
			}]
		})
	</script>

</html>